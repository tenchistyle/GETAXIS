<!DOCTYPE html> 
<html>
<head>
<meta charset="utf-8">
<title>Ingreso Getaxis</title>
<link href="jquery-mobile/jquery.mobile-1.0a3.min.css" rel="stylesheet" type="text/css"/>
<script src="jquery-mobile/jquery-1.5.min.js" type="text/javascript"></script>
<script src="jquery-mobile/jquery.mobile-1.0a3.min.js" type="text/javascript"></script>
<script src="/phonegap.js" type="text/javascript"></script>
<script type="text/javascript">
function leerGET(){ 
  var cadGET = location.search.substr(1,location.search.length); 
  var arrGET = cadGET.split("&"); 
  var asocGET = new Array(); 
  var variable = ""; 
  var valor = ""; 
  for(i=0;i<arrGET.length;i++){ 
    var aux = arrGET[i].split("="); 
    variable = aux[0]; 
    valor = aux[1]; 
    asocGET[variable] = valor; 
  } 
  return asocGET; 
} 
var paresVarValor = leerGET();
var taxista= paresVarValor["taxista"];
</script>
<script type="text/javascript">
function creaRequest()
{	
if (window.XMLHttpRequest) {
        return new window.XMLHttpRequest;
    }
    else {
        try {
            return new ActiveXObject("MSXML2.XMLHTTP.3.0");
        }
        catch(ex) {
			alert(ex);
            return null;
        }
    }
}

var http = creaRequest();
var lati;
var longi;
var user;
var actualiza = 0;
var entro = 0;
var ip = "201.239.164.111"

//primero, determina el estado y lo deja en 1 si es disponible y en 0 si presiona el boton no disponible
//en el caso de estar disponible actualiza inmediatamente las coordenadas del taxista y posteriormente las actualiza cada 5 segundos.
//pregunta cada 5 segundos si el taxista fue solicitado.

//actualiza la coordenadas cada 5 segundos (puede cambiar cuando implementemos mysql)
window.setInterval("updateBD()", 2000);

function updateBD()
{
	var url = "http://"+ip+"/Getaxis/Taxista/updateCoordenadas.php?taxista="+taxista+"&lati="+lati+"&longi="+longi;
	//alert(url);
	if (http != null) {
    	http.open("GET", url, true);
    	http.onreadystatechange = handler2;
    	http.send();
    }
	else {
    alert("AJAX (XMLHTTP) not supported.");}
}
function handler2()
{
    if (!http.readyState == 4 /* complete */) {
		alert("Ocurrio un error");
    }
}


function handler()
{
    if (http.readyState == 4 /* complete */) {
		if (http.status == 200){
			var pasajero= http.responseText;
			if(http.responseText != false)
			{
		   location.href="FuiSolicitado.html?taxista="+taxista+"&pasajero="+pasajero;}
		}
    }
}


    var watchID = null;

    // PhoneGap esta lista
    //
    function Inicia() {
        // Actualizar cada 3 segus
        var options = {frequency:2000, enableHighAccuracy:true, timeout:27000};
		watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
    }

    // Función onSuccess
    //
    function onSuccess(position) {

			lati = position.coords.latitude;
			longi = position.coords.longitude;
			if(entro == 0)
			{
				entro = 1;
				updateBD();
			}
			//alert(longi);
			var url = "http://"+ip+"/Getaxis/Taxista/TaxistaAPasajero.php?taxista="+taxista+"&lati="+lati+"&longi="+longi;
			if (http != null) {
				http.open("GET", url, true);
				http.onreadystatechange = handler;
				http.send();
			}
			else {
				alert("AJAX (XMLHTTP) not supported.");
			}
		
			//user = "tenchi2";
			
			
			/*var url =			"http://201.239.166.124/Getaxis/Taxista/actualizaCoordenada.php?user="+user+"&lati="+lati+"&longi="+longi;
	
if (http != null) {
    http.open("GET", url, true);
    http.onreadystatechange = handler;
    http.send();
}
else {
    alert("AJAX (XMLHTTP) not supported.");
}
		}*/
    }

    // Función onError
    //
    function onError(error) {
        alert('código: '    + error.code    + '\n' +
              'mensaje: ' + error.message + '\n');
    }
function noDisponible()
{
	var url = "http://"+ip+"/Getaxis/Taxista/modoIndisponible.php?taxista="+taxista;
			if (http != null) {
				http.open("GET", url, true);
				http.onreadystatechange = handler4;
				http.send();
			}
			else {
				alert("AJAX (XMLHTTP) not supported.");
			}
}
function handler4()
{
    if (!http.readyState == 4 /* complete */) {
		alert("Ocurrio un error");
    }
	else
	{
		location.href = "menu.html?taxista="+taxista;
	}
}
</script>

</head> 
<body onLoad="Inicia()"> 

<div data-role="page" id="page">
	<div data-role="header">
		Online:<script type="text/javascript">
  document.write(" "+taxista);
</script>
	</div>
	<div data-role="header">
		<h1>Modo Disponible</h1>
	</div>
    <div data-role="content">
    <br><br><br><br>
      <h1>Esperando una Solicitud...</h1>
      <button onClick="noDisponible()"data-icon="minus">No Disponible</button>
<br><br><br><br><br>
    </div>
	<div data-role="footer">
		<h4>XtreamSoft @ [Taxista V.1.0]</h4>
	</div>
</div>
</body>
</html>
